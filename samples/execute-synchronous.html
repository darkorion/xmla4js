<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>xmla4js: Execute</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css"/>
        <style type="text/css">
            #input_url {
                width: 100%;
            }
            
            #section_error {
                border-style:outset;
                border-width: 2px;
                margin-top: 1em;
                margin-bottom: 1em;
                background-color: red;
                color: white;
            }
            
            #textarea_statement {
                width:100%;
                height:10em;
            }
                        
            table {
                border-color: ThreeDFace;
                border-style: outset;
                border-width:2px;
            }
            td.th {
                font-weight: bold;
                text-align: center;
                background-color: ThreeDFace;
            }
            td {
            }
        </style>
    </head>
    <body>
        <h1>Execute</h1>
        <fieldset>
            URL:
            <input type="text" id="input_url" name="input_url" 
                value="http://localhost:8080/pentaho/Xmla?userid=joe&amp;password=password"
            />
            <button id="button_discover" name="button_discover">Discover Datasources...</button>            
            <div>
                <label>DataSource:</label>
                <select id="select_datasources" name="select_datasources"></select>            
            <div>
            <div>
                <label>Catalog:</label>
                <select id="select_catalogs" name="select_catalgogs"></select>            
            <div>
        </fieldset>
        <fieldset>
            MDX Statement:
            <textarea id="textarea_statement"></textarea>
            <button id="button_execute" name="button_execute">Execute Statement...</button>            
        </fieldset>
        <div id="section_error"></div>
        <pre id="section_request"></pre>
        <pre id="section_response"></pre>

        <script type="text/javascript" src="../src/Xmla.js"></script>
                
        <script type="text/javascript">
            var xmla = new Xmla({
                async: false
            });
            var dataSourceCache = [];

            var input_url = document.getElementById("input_url");
            var select_datasources = document.getElementById("select_datasources");
            var select_catalogs = document.getElementById("select_catalogs");
            var button_discover = document.getElementById("button_discover");
            var section_error = document.getElementById("section_error");
            var section_request = document.getElementById("section_request");
            var section_response = document.getElementById("section_response");

            function showException(exception){
                if (exception instanceof Xmla.Exception){
                    section_error.innerHTML = "" +
                    "<div>code: " + exception.code + "<\/div>" +
                    "<div>message: " + exception.message + "<\/div>" +
                    "<div>source: " + exception.source + "<\/div>" +
                    "<div>helpfile: <a href=\"" + exception.helpfile + "\">" + exception.helpfile + "</a>"
                    ;
                }
                else {                   
                    section_error.innerHTML = exception;
                }
            }
            
            function populate_datasources(){
                debugger;
                select_datasources.disabled = true; //prevent user from choosing a new datasource while we're busy
                select_catalogs.disabled = true; //prevent user from choosing a new datasource while we're busy
                try {
                    select_datasources.innerHTML = "";
                    var rowset = xmla.discoverDataSources({
                        url: input_url.value
                    });
                    if (rowset.hasMoreRows()) {
                        dataSourceCache = rowset.fetchAllAsObject();
                        for (var numDataSources = dataSourceCache.length, i=0; i<numDataSources; i++){
                            select_datasources.innerHTML += "<option>" +  dataSourceCache[i].DataSourceName +"<\/option>";
                        }
                        populate_catalogs()
                    } 
                    else {
                        section_error.innerHTML = "No datasources found";
                    }
                } catch (exception){
                    showException(exception);
                }
                select_datasources.disabled = false; //unlock ui again.
                select_catalogs.disabled = false;
            }

            function populate_catalogs(){
                try {
                    select_catalogs.innerHTML = "";
                    var datasource = dataSourceCache[select_datasources.selectedIndex];
                    var properties = {};
                    properties[Xmla.PROP_DATASOURCEINFO] = datasource[Xmla.PROP_DATASOURCEINFO];
                    var rowset = xmla.discoverDBCatalogs({
                        url: datasource["URL"],
                        properties: properties
                    });
                    if (rowset.hasMoreRows()) {
                        var catalog;
                        while (catalog = rowset.fetchAsObject()){
                            select_catalogs.innerHTML += "<option>" +  catalog["CATALOG_NAME"] +"<\/option>";
                        }                        
                    } 
                    else {
                        section_error.innerHTML = "No catalogs found";
                    }
                } catch(exception) {
                    showException(exception);
                }
            }
            
            select_datasources.onchange = populate_catalogs;        
            button_discover.onclick = populate_datasources;
            
        </script>
    </body>
</html>