<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!--
    Copyright 2009,2010 Roland Bouman 
    (Roland.Bouman@gmail.com, http://rpbouman.blogspot.com/, http://code.google.com/p/xmla4js)
    
    discover-schema-rowsets.html - this software is part of xmla4js

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Lesser General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->    
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>xmla4js: Discover Schema Rowsets</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css"/>
        <style type="text/css">
            #url {
                width: 100%;
            }
            
            .error {
                border-style:outset;
                border-width: 2px;
                margin-top: 1em;
                margin-bottom: 1em;
                background-color: red;
                color: white;
            }
            
            table {
                border-color: ThreeDFace;
                border-style: outset;
                border-width:2px;
            }
            td.th {
                font-weight: bold;
                text-align: center;
                background-color: ThreeDFace;
            }
            td {
            }
        </style>
    </head>
    <body>
        <div>
            <a href="../index.html">Home</a>
            |
            <a href="http://code.google.com/p/xmla4js/">Google Code Project page</a>
            |
            <a href="index.html">Samples</a>
            |
            <a href="../doc/api/index.html">API Reference Documentation</a>
        </div>
        <h1>Sample: Schema Rowsets</h1>
        <div>
            URL:
            <input type="text" id="url" name="url" 
                value="http://localhost:8080/pentaho/Xmla?userid=joe&amp;password=password"
            />
            <button id="discover">Discover...</button>            
        </div>

        <div id="schemaRowsets">
        </div>
        <div id="section_error" class="error">
        </div>


        <script type="text/javascript" src="../src/Xmla.js"></script>
                
        <script type="text/javascript">
            var discover = document.getElementById("discover");
            var xmla = new Xmla({});
			var datasourceIndependentRowsets = {};
			datasourceIndependentRowsets[Xmla.DISCOVER_DATASOURCES] = Xmla.DISCOVER_DATASOURCES;
			datasourceIndependentRowsets[Xmla.DISCOVER_ENUMERATORS] = Xmla.DISCOVER_ENUMERATORS;
			datasourceIndependentRowsets[Xmla.DISCOVER_KEYWORDS] = Xmla.DISCOVER_KEYWORDS;
			datasourceIndependentRowsets[Xmla.DISCOVER_LITERALS] = Xmla.DISCOVER_LITERALS;
			datasourceIndependentRowsets[Xmla.DISCOVER_PROPERTIES] = Xmla.DISCOVER_PROPERTIES;
			datasourceIndependentRowsets[Xmla.DISCOVER_SCHEMA_ROWSETS] = Xmla.DISCOVER_SCHEMA_ROWSETS;

            function showException(exception, element){
			    var msg;
                if (exception instanceof Xmla.Exception){
                    msg = "" +
                    "<div>code: " + exception.code + "<\/div>" +
                    "<div>message: " + exception.message + "<\/div>" +
                    "<div>source: " + exception.source + "<\/div>" +
                    "<div>helpfile: <a href=\"" + exception.helpfile + "\">" + exception.helpfile + "<\/a>"
                    ;
                }
                else 
                if (exception.message) {
                    msg = exception.message;
                }
                else {                   
                    msg = exception;
                }
				element.innerHTML += msg;
            }

			function getUrl(){
				return document.getElementById("url").value;
			}
			
			function fillDataSourceIndependentTables(){
				var schemaRowsetsEl = document.getElementById("schemaRowsets");
                var url = getUrl();
                xmla.setOptions({async: false, url: url});
				for (var p in datasourceIndependentRowsets){
					xmla.setOptions({requestType: p});
					fillTable(p, xmla, xmla.discover);
				}
			}
			
			function fillPerDataSourceTables(){
				try {
					var fallbackUrl = getUrl();
					var schemaRowsetsEl = document.getElementById("schemaRowsets");
					var datasource, datasources = xmla.discoverDataSources();
					while (datasource = datasources.fetchAsObject()) {
						schemaRowsetsEl.innerHTML += "<hr />";
						var url = datasource.URL;
						if (!url){
							url = fallbackUrl;
						}
						xmla.setOptions({
							async: false,
							url: url,
							properties: {
								DataSourceInfo: datasource.DataSourceInfo
							}
						});
						var schemaRowset, schemaRowsets = xmla.discoverSchemaRowsets();
						while (schemaRowset = schemaRowsets.fetchAsObject()){
							if (!datasourceIndependentRowsets[schemaRowset.SchemaName]){
								xmla.setOptions({requestType: schemaRowset.SchemaName});
								fillTable(schemaRowset.SchemaName, xmla, xmla.discover);
							}
						}
						schemaRowsets.close();
					}
					datasources.close();
				} catch (exception){
					showException(exception, document.getElementById("section_error"));
				}
			}
			
            function fillTable(name, obj, func){ 
                var tab = document.createElement("table");
                tab.setAttribute("border", "1");
                var caption = tab.createCaption();
				caption.innerHTML = name;
                var schemaRowsetsEl = document.getElementById("schemaRowsets");
                schemaRowsetsEl.appendChild(tab);
				
				try {
					var rowset = func.apply(xmla);
					var c, i, r = tab.insertRow(0), fieldCount = rowset.fieldCount();
					for (i=0; i<fieldCount; i++){
						c = r.insertCell(i);
						c.innerHTML = rowset.fieldName(i);
						c.setAttribute("class", "th");
					}
					var rows = rowset.fetchAllAsArray();                
					for (var rowCount = rows.length, j=0; j<rowCount; j++){
						r = tab.insertRow(j+1);
						for (i=0; i<fieldCount; i++){
							c = r.insertCell(i);
							c.innerHTML = rows[j][i];
						}
					}
					rowset.close();
				} catch (exception){
					showException(exception, caption);
				}
            }
            
            discover.onclick = function(){
                var schemaRowsetsEl = document.getElementById("schemaRowsets");
                schemaRowsetsEl.innerHTML = "";
				fillDataSourceIndependentTables();				
				fillPerDataSourceTables();
            }
        </script>
    </body>
</html>